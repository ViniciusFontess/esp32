<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">

    <title>Medição de Altura</title>
</head>
<body>
    <div class="container">
        <div class="top-bar" style="position:fixed;top:18px;right:32px;z-index:10;">
            <button id="connect-btn" class="connect-btn-small">Conectar ao Sensor</button>
        </div>
        <h1>Medição de Altura</h1>
        <div class="status">
            <div class="status-indicator"></div>
            <span id="status-text">Desconectado</span>
        </div>
        <div class="display">
            <h2>Altura Atual</h2>
            <div class="distance-value"><span id="distance">--</span><span class="unit">cm</span></div>
        </div>
        <div class="measure-center">
            <button id="measure-btn" class="measure-btn-styled" disabled>Medir Altura</button>
        </div>
    </div>
    <form id="alturaForm" action="/dados/altura_verif" method="post" style="display:none;">
        <input type="hidden" name="altura" id="alturaInput">
    </form>
    <script>
    let connected = false;
    let lastMeasurement = null;
    let characteristic = null;
    const SERVICE_UUID = '19b10000-e8f2-537e-4f6c-d104768a1214';
    const CHAR_UUID = '19b10001-e8f2-537e-4f6c-d104768a1214';
    const connectBtn = document.getElementById('connect-btn');
    const measureBtn = document.getElementById('measure-btn');
    const distanceElement = document.getElementById('distance');
    const statusText = document.getElementById('status-text');
    const statusIndicator = document.querySelector('.status-indicator');
    const statusContainer = document.querySelector('.status');

    function updateStatus(isConnected) {
        connected = isConnected;
        if (connected) {
            statusText.textContent = 'Conectado';
            statusContainer.classList.add('connected');
            connectBtn.textContent = 'Desconectar';
            measureBtn.disabled = false;
        } else {
            statusText.textContent = 'Desconectado';
            statusContainer.classList.remove('connected');
            connectBtn.textContent = 'Conectar ao Sensor';
            measureBtn.disabled = true;
            distanceElement.textContent = '--';
        }
    }

    let bluetoothDevice = null;
    function connect() {
        if (connected) {
            // Desconectar
            if (characteristic) {
                try {
                    characteristic.removeEventListener('characteristicvaluechanged', handleData);
                    characteristic.stopNotifications();
                } catch (e) {}
            }
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                bluetoothDevice.gatt.disconnect();
            }
            characteristic = null;
            bluetoothDevice = null;
            lastMeasurement = null;
            updateStatus(false);
            return;
        }
        navigator.bluetooth.requestDevice({
            // Usa filtro por serviço para garantir descoberta, mesmo se o nome variar
            filters: [
                { services: [SERVICE_UUID] },
                { namePrefix: 'ESP32' },
                { name: 'ESP32-LIDAR' }
            ],
            optionalServices: [SERVICE_UUID]
        })
        .then(device => {
            bluetoothDevice = device;
            // auto-reconexão se desconectar inesperadamente
            bluetoothDevice.addEventListener('gattserverdisconnected', tryReconnect);
            return device.gatt.connect();
        })
        .then(server => server.getPrimaryService(SERVICE_UUID))
        .then(service => service.getCharacteristic(CHAR_UUID))
        .then(char => {
            updateStatus(true);
            characteristic = char;
            characteristic.addEventListener('characteristicvaluechanged', handleData);
            return characteristic.startNotifications();
        })
        .catch(error => {
            console.error('Erro BLE:', error);
            alert('Falha na conexão. Verifique se o dispositivo está disponível e se o navegador tem permissão para usar Bluetooth.');
        });
    }

    let reconnectAttempts = 0;
    function tryReconnect() {
        if (!bluetoothDevice) return;
        updateStatus(false);
        if (reconnectAttempts >= 3) return; // evita loop infinito
        reconnectAttempts++;
        setTimeout(() => {
            bluetoothDevice.gatt.connect()
            .then(server => server.getPrimaryService(SERVICE_UUID))
            .then(service => service.getCharacteristic(CHAR_UUID))
            .then(char => {
                reconnectAttempts = 0;
                characteristic = char;
                characteristic.addEventListener('characteristicvaluechanged', handleData);
                updateStatus(true);
                return characteristic.startNotifications();
            })
            .catch(err => console.warn('Tentativa de reconexão falhou:', err));
        }, 1000 * reconnectAttempts);
    }

    function handleData(event) {
        let value = new TextDecoder().decode(event.target.value);
        try {
            let data = JSON.parse(value);
            lastMeasurement = data.distance;
        } catch (e) {
            let num = parseFloat(value);
            if (!isNaN(num)) lastMeasurement = num;
        }
    }

    connectBtn.onclick = connect;

    measureBtn.onclick = function() {
        if (lastMeasurement !== null && connected) {
            distanceElement.textContent = lastMeasurement;
        } else {
            distanceElement.textContent = '--';
        }
    };

    window.onload = function() {
        if (!navigator.bluetooth) {
            alert('Seu navegador não suporta Web Bluetooth. Tente usar Chrome ou Edge.');
            connectBtn.disabled = true;
            measureBtn.disabled = true;
            return;
        }
        // Web Bluetooth requer contexto seguro (HTTPS) ou localhost
        const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
        if (!isSecure) {
            console.warn('Para usar Web Bluetooth, sirva a página via HTTPS ou localhost.');
            alert('Para usar Bluetooth no navegador, abra esta página via HTTPS ou em localhost (ex.: http://localhost:8080).');
        }
    };
    </script>
</body>
</html>
