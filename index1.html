<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Sistema de Medição de Altura</title>
    <style>
        :root{
            --bg:#f4f7fb;
            --card:#ffffff;
            --accent:#1768FF;
            --muted:#64748b;
            --success:#16a34a;
            --danger:#dc2626;
            --glass: rgba(255,255,255,0.6);
            --radius:12px;
            --shadow: 0 6px 22px rgba(23,40,80,0.08);
            --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
            --sans: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }

        html,body{
            height:100%;
            margin:0;
            font-family:var(--sans);
            background: linear-gradient(180deg,var(--bg) 0%, #eef3fb 100%);
            color:#0f172a;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
        }

        .wrap{
            max-width:980px;
            margin:40px auto;
            padding:28px;
        }

        header.app-header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:20px;
            margin-bottom:20px;
        }

        .brand{
            display:flex;
            gap:14px;
            align-items:center;
        }

        .brand h1{
            margin:0;
            font-size:20px;
            letter-spacing:0.2px;
            font-weight:600;
        }

        .card{
            background:var(--card);
            border-radius:var(--radius);
            box-shadow:var(--shadow);
            padding:22px;
            overflow:hidden;
        }

        .controls{
            display:flex;
            flex-wrap:wrap;
            gap:12px;
            align-items:center;
        }

        .primary{
            background: linear-gradient(90deg,var(--accent), #2b6ef6);
            color:white;
            border:none;
            padding:12px 18px;
            border-radius:10px;
            font-weight:600;
            cursor:pointer;
            transition:transform .12s ease, box-shadow .12s ease, opacity .12s;
            box-shadow: 0 6px 16px rgba(23,40,80,0.08);
        }

        .primary:active{ transform:translateY(1px); }
        .primary[disabled]{ opacity:.5; cursor:not-allowed; box-shadow:none; transform:none; }

        .secondary{
            background:transparent;
            border:1px solid #e6eefc;
            color:var(--accent);
            padding:10px 14px;
            border-radius:10px;
            cursor:pointer;
            font-weight:600;
        }
        .secondary[disabled]{ opacity:.6; cursor:not-allowed; }

        .danger{
            background:transparent;
            border:1px solid rgba(220,38,38,0.08);
            color:var(--danger);
            padding:8px 12px;
            border-radius:10px;
            font-weight:600;
            cursor:pointer;
        }

        .status{
            display:inline-flex;
            align-items:center;
            gap:10px;
            padding:10px 14px;
            border-radius:10px;
            font-weight:600;
        }
        .status .dot{
            width:10px;height:10px;border-radius:50%;
            background:#f43f5e;
            box-shadow:0 0 0 4px rgba(244,63,94,0.06);
        }
        .status.connected .dot{ background:var(--success); box-shadow:0 0 0 6px rgba(22,163,74,0.06); }
        .status.connected{ color:var(--success); border:1px solid rgba(22,163,74,0.06); padding-right:16px; }

        .grid{
            display:grid;
            grid-template-columns: 1fr 360px;
            gap:18px;
            margin-top:18px;
        }
        @media (max-width:900px){
            .grid{ grid-template-columns: 1fr; }
        }

        .info{
            background:linear-gradient(180deg,#fbfdff,#ffffff);
            padding:14px;
            border-radius:10px;
            border:1px solid #eef6ff;
            color:var(--muted);
            font-size:14px;
        }

        .actions{
            display:flex;
            gap:10px;
            margin-top:14px;
        }

        .result{
            margin-top:16px;
            padding:18px;
            border-radius:10px;
            background: linear-gradient(90deg,#f7fff6,#ffffff);
            border:1px solid rgba(16,185,129,0.06);
            color:#064e3b;
            font-size:20px;
            font-weight:700;
            text-align:center;
        }

        .calibration{
            margin-top:8px;
            padding:12px;
            border-radius:8px;
            background:#fffaf0;
            border:1px solid rgba(255,159,0,0.08);
            color:#7c2d12;
            font-weight:600;
            text-align:center;
        }

        .progress-wrap{
            margin-top:12px;
        }

        .progress-bar{
            height:12px;
            background:#eef2ff;
            border-radius:999px;
            overflow:hidden;
        }

        .progress-fill{
            height:100%;
            width:0%;
            background: linear-gradient(90deg,var(--accent), #2b6ef6);
            transition: width .28s ease;
        }

        .log{
            margin-top:18px;
            background: #0b1220;
            color: #e6eefc;
            border-radius:10px;
            padding:12px;
            font-family:var(--mono);
            font-size:12px;
            height:240px;
            overflow:auto;
            line-height:1.5;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.02);
        }

        .small{
            font-size:13px;
            color:var(--muted);
        }

        footer{
            margin-top:18px;
            color:var(--muted);
            font-size:13px;
            display:flex;
            justify-content:space-between;
            gap:12px;
            align-items:center;
        }
    </style>
</head>
<body>
    <div class="wrap">
        <header class="app-header">
            <div class="brand">
                <div>
                    <h1>Sistema de Medição de Altura</h1>
                    <div class="small">Controle e leitura via ESP32</div>
                </div>
            </div>

            <div class="controls">
                <div id="status" class="status disconnected" aria-live="polite">
                    <span class="dot" aria-hidden="true"></span>
                    <span id="statusText">Status: Desconectado</span>
                </div>

                <button id="connectButton" class="primary">Conectar ao ESP32</button>
            </div>
        </header>

        <main class="card">
            <div class="grid">
                <section>
                    <div class="info" aria-hidden="false">
                        <strong>Instruções</strong>
                        <ol style="margin:8px 0 0 18px; padding:0;">
                            <li>Conecte ao dispositivo ESP32</li>
                            <li>Realize a calibragem (uma vez, quando necessário)</li>
                            <li>Inicie a medição de altura</li>
                        </ol>
                    </div>

                    <div class="actions" role="group" aria-label="Ações">
                        <button id="calibrateButton" class="secondary" disabled>Calibrar</button>
                        <button id="measureButton" class="secondary" disabled>Medir altura</button>
                        <button id="clearLog" class="danger" title="Limpar registro">Limpar log</button>
                    </div>

                    <div id="progressContainer" class="progress-wrap" style="display:none;">
                        <div class="small" id="progressText">Processando...</div>
                        <div class="progress-bar" aria-hidden="false" style="margin-top:8px;">
                            <div id="progressFill" class="progress-fill" style="width:0%"></div>
                        </div>
                    </div>

                    <div id="calibrationResult" class="calibration" style="display:none;">
                        Calibragem: <span id="alturaFixaValue">--</span> cm
                    </div>

                    <div id="result" class="result" style="display:none;">
                        Altura: <span id="heightValue">--</span> cm
                    </div>

                    <div style="margin-top:14px;">
                        <h4 style="margin:0 0 8px 0">Log do sistema</h4>
                        <div id="log" class="log" aria-live="polite"></div>
                    </div>
                </section>

                <aside>
                    <div class="info" style="display:flex;flex-direction:column;gap:10px;">
                        <div>
                            <strong>Detalhes da conexão</strong>
                            <div class="small" id="deviceInfo">Nenhum dispositivo conectado</div>
                        </div>

                        <div>
                            <strong>Última leitura</strong>
                            <div class="small" id="lastReading">--</div>
                        </div>

                        <div style="margin-top:auto; display:flex; gap:8px;">
                            <button id="disconnectButton" class="secondary" disabled>Desconectar</button>
                        </div>
                    </div>
                </aside>
            </div>

            <footer>
                <div>Versão local • uso experimental</div>
                <div class="small">Conecte via Bluetooth no navegador (Chrome/Edge)</div>
            </footer>
        </main>
    </div>

    <script>
        let device = null;
        let server = null;
        let service = null;
        let characteristic = null;
        let commandCharacteristic = null;

        const serviceUUID = '19b10000-e8f2-537e-4f6c-d104768a1214';
        const sensorCharacteristicUUID = '19b10001-e8f2-537e-4f6c-d104768a1214';
        const commandCharacteristicUUID = '19b10002-e8f2-537e-4f6c-d104768a1214';

        const connectButton = document.getElementById('connectButton');
        const calibrateButton = document.getElementById('calibrateButton');
        const measureButton = document.getElementById('measureButton');
        const disconnectButton = document.getElementById('disconnectButton');
        const clearLogButton = document.getElementById('clearLog');

        connectButton.addEventListener('click', connect);
        calibrateButton.addEventListener('click', calibrate);
        measureButton.addEventListener('click', measureHeight);
        disconnectButton.addEventListener('click', disconnect);
        clearLogButton.addEventListener('click', () => { document.getElementById('log').textContent = ''; });

        async function connect() {
            try {
                log('Procurando dispositivo ESP32-Altura...');
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'ESP32-Altura' }],
                    optionalServices: [serviceUUID]
                });

                if (!device) {
                    log('Nenhum dispositivo selecionado.');
                    return;
                }

                device.addEventListener('gattserverdisconnected', onDisconnected);

                log('Conectando ao dispositivo...');
                server = await device.gatt.connect();

                log('Obtendo serviço...');
                service = await server.getPrimaryService(serviceUUID);

                log('Obtendo características...');
                characteristic = await service.getCharacteristic(sensorCharacteristicUUID);
                commandCharacteristic = await service.getCharacteristic(commandCharacteristicUUID);

                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleData);

                updateStatus('Conectado', true);
                connectButton.disabled = true;
                calibrateButton.disabled = false;
                measureButton.disabled = false;
                disconnectButton.disabled = false;

                document.getElementById('deviceInfo').textContent = device.name || device.id;
                log('Conectado com sucesso.');

            } catch (error) {
                log('Erro na conexão: ' + error);
            }
        }

        async function disconnect() {
            if (device && device.gatt && device.gatt.connected) {
                device.gatt.disconnect();
            } else {
                log('Nenhum dispositivo conectado.');
            }
        }

        async function calibrate() {
            if (!commandCharacteristic) return;

            try {
                calibrateButton.disabled = true;
                measureButton.disabled = true;

                showProgress('Calibragem em andamento...', 0);

                const command = new TextEncoder().encode('CALIBRAR');
                await commandCharacteristic.writeValue(command);
                log('Comando de calibragem enviado.');

            } catch (error) {
                log('Erro ao enviar comando de calibragem: ' + error);
                calibrateButton.disabled = false;
                measureButton.disabled = false;
                hideProgress();
            }
        }

        async function measureHeight() {
            if (!commandCharacteristic) return;

            try {
                measureButton.disabled = true;
                showProgress('Medição em andamento...', 0);

                const command = new TextEncoder().encode('MEDIR');
                await commandCharacteristic.writeValue(command);
                log('Comando de medição enviado.');

            } catch (error) {
                log('Erro ao enviar comando de medição: ' + error);
                measureButton.disabled = false;
                hideProgress();
            }
        }

        function handleData(event) {
            const value = new TextDecoder().decode(event.target.value);
            try {
                const data = JSON.parse(value);

                if (data.tipo === 'calibragem') {
                    handleCalibrationData(data);
                } else if (data.tipo === 'medicao') {
                    handleMeasurementData(data);
                }
            } catch (e) {
                log('Erro ao processar dados: ' + e);
            }
        }

        function handleCalibrationData(data) {
            if (data.status === 'iniciando') {
                log('Iniciando processo de calibragem...');
                showProgress('Calibragem iniciada...', 0);
            } else if (data.progresso !== undefined) {
                showProgress(`Calibrando... ${data.progresso}%`, data.progresso);
                log(`Progresso da calibragem: ${data.progresso}%`);
            } else if (data.status === 'concluido') {
                log(`Calibragem concluída. Altura fixa: ${data.alturaFixa} cm`);
                hideProgress();

                document.getElementById('alturaFixaValue').textContent = data.alturaFixa;
                document.getElementById('calibrationResult').style.display = 'block';

                calibrateButton.disabled = false;
                measureButton.disabled = false;
                document.getElementById('lastReading').textContent = `Calibragem: ${data.alturaFixa} cm`;
            } else if (data.status === 'erro') {
                log('Erro na calibragem: ' + data.mensagem);
                hideProgress();
                calibrateButton.disabled = false;
                measureButton.disabled = false;
            }
        }

        function handleMeasurementData(data) {
            if (data.status === 'iniciando') {
                log('Iniciando medição de altura...');
                showProgress('Medição iniciada...', 0);
            } else if (data.progresso !== undefined) {
                showProgress(`Medindo... ${data.progresso}%`, data.progresso);
                log(`Progresso da medição: ${data.progresso}%`);
            } else if (data.status === 'concluido') {
                log(`Medição concluída. Altura: ${data.altura} cm`);
                hideProgress();

                document.getElementById('heightValue').textContent = data.altura;
                document.getElementById('result').style.display = 'block';

                measureButton.disabled = false;
                document.getElementById('lastReading').textContent = `Altura: ${data.altura} cm`;
            } else if (data.status === 'erro') {
                log('Erro na medição: ' + data.mensagem);
                hideProgress();
                measureButton.disabled = false;
            }
        }

        function showProgress(text, percent) {
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('progressText').textContent = text;
            document.getElementById('progressFill').style.width = percent + '%';
        }

        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('progressFill').style.width = '0%';
        }

        function updateStatus(message, connected) {
            const statusElement = document.getElementById('status');
            const statusText = document.getElementById('statusText');
            statusText.textContent = `Status: ${message}`;
            statusElement.className = `status ${connected ? 'connected' : 'disconnected'}`;
        }

        function onDisconnected() {
            updateStatus('Desconectado', false);
            connectButton.disabled = false;
            calibrateButton.disabled = true;
            measureButton.disabled = true;
            disconnectButton.disabled = true;
            document.getElementById('result').style.display = 'none';
            document.getElementById('calibrationResult').style.display = 'none';
            hideProgress();
            document.getElementById('deviceInfo').textContent = 'Nenhum dispositivo conectado';
            log('Dispositivo desconectado.');
        }

        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const line = `[${timestamp}] ${message}\n`;
            logElement.textContent = line + logElement.textContent;
        }
    </script>
</body>
</html>
